<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stocktake Pro | GTS Advanced Auditor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --brand-blue: #3b82f6; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        .scanning-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(to bottom, transparent, var(--brand-blue));
            box-shadow: 0 0 20px var(--brand-blue);
            animation: scan 2s ease-in-out infinite;
            display: none; z-index: 10;
        }
        @keyframes scan { 0%, 100% { top: 5%; opacity: 0.2; } 50% { top: 95%; opacity: 1; } }
        
        .shutter-flash { position: absolute; inset: 0; background: white; opacity: 0; pointer-events: none; z-index: 20; }
        .flash-active { animation: flash 0.3s ease-out; }
        @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }

        .item-row { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen font-sans">
    <div class="max-w-md mx-auto p-4 pb-44">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 pt-4">
            <div>
                <h1 class="text-2xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400 uppercase">Stocktake Pro</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-emerald-500"></span>
                    <span id="status-text" class="text-[10px] font-bold uppercase tracking-widest text-slate-500">GTS Voice Active</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="voice-toggle" class="p-2 glass rounded-lg text-blue-400 hover:text-white transition-colors">
                    <svg id="voice-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                </button>
                <button id="switch-camera" class="p-2 glass rounded-lg text-slate-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
                </button>
            </div>
        </header>

        <!-- Camera Container -->
        <div id="video-container" class="aspect-[4/3] bg-slate-900 mb-4 relative rounded-3xl overflow-hidden ring-1 ring-white/10 shadow-2xl">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <canvas id="canvas" class="hidden"></canvas>
            <div id="shutter-effect" class="shutter-flash"></div>
            <div id="scanning-overlay" class="scanning-line"></div>
            
            <!-- Focus Guide -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20">
                <div class="w-48 h-48 border border-white rounded-2xl"></div>
            </div>
        </div>

        <!-- Trigger Button -->
        <button id="capture-btn" class="w-full bg-blue-600 hover:bg-blue-500 active:scale-[0.98] transition-all py-5 rounded-2xl font-black flex items-center justify-center gap-3 mb-8 shadow-xl shadow-blue-900/30 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
            <span id="btn-label">SCAN VISIBLE ITEMS</span>
        </button>

        <!-- REVIEW LIST -->
        <div id="selection-area" class="hidden space-y-4 mb-10 item-row">
            <div class="flex justify-between items-center px-1 border-b border-white/5 pb-2">
                <h2 class="text-xs font-black uppercase tracking-[0.2em] text-blue-400">Review Results</h2>
                <span class="text-[10px] text-slate-500 font-bold">SELECT TO ADD</span>
            </div>
            <div id="detection-results" class="space-y-2 max-h-60 overflow-y-auto pr-1">
                <!-- AI results populated here -->
            </div>
            <div class="flex gap-2 pt-2">
                <button id="cancel-selection" class="flex-1 py-4 rounded-xl bg-slate-800 text-[10px] font-black uppercase tracking-widest text-slate-400">Discard</button>
                <button id="confirm-selection" class="flex-[2] py-4 rounded-xl bg-emerald-600 text-[10px] font-black uppercase tracking-widest shadow-lg shadow-emerald-900/20">Add to Count</button>
            </div>
        </div>

        <!-- MASTER INVENTORY LIST -->
        <div class="space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-400">Inventory Batch</h2>
                <button id="clear-list" class="text-[10px] font-black uppercase text-red-500 hover:underline">Clear All</button>
            </div>
            <div id="inventory-list" class="space-y-3">
                <div class="text-center py-12 glass rounded-3xl border-dashed border-white/10">
                    <p class="text-slate-600 text-[10px] font-black uppercase tracking-widest">No stock scanned yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Action Bar -->
    <div class="fixed bottom-0 left-0 right-0 p-6 glass border-t border-white/5 z-50">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <p class="text-[10px] uppercase font-black tracking-widest text-slate-500 mb-1">Total Items</p>
                <div class="flex items-baseline gap-1">
                    <span id="total-units" class="text-4xl font-black leading-none text-blue-400">0</span>
                    <span class="text-[10px] font-bold text-slate-600 uppercase">Qty</span>
                </div>
            </div>
            <button id="export-btn" class="bg-white text-black px-10 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-transform">Export CSV</button>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-[100] hidden">
        <div class="bg-slate-900 border border-white/10 rounded-3xl p-8 max-w-sm w-full shadow-2xl">
            <h3 class="text-red-400 font-black text-xl mb-2">SYSTEM ERROR</h3>
            <p id="error-message" class="text-slate-400 text-sm mb-6 leading-relaxed"></p>
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="w-full py-3 bg-slate-800 rounded-xl font-bold text-sm uppercase tracking-widest">Dismiss</button>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyAam1dcx50scy34f0wh2hZejBXyeMqLxx8";
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const selectionArea = document.getElementById('selection-area');
        const detectionResults = document.getElementById('detection-results');
        const inventoryList = document.getElementById('inventory-list');
        const totalUnitsEl = document.getElementById('total-units');
        const voiceToggle = document.getElementById('voice-toggle');

        let inventory = {};
        let currentScanResults = [];
        let useFrontCamera = false;
        let voiceEnabled = true;

        // --- GTS VERBAL COMMUNICATION SYSTEM ---
        
        async function speak(text) {
            if (!voiceEnabled) return;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say clearly and professionally: ${text}` }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } 
                        }
                    })
                });

                if (!response.ok) throw new Error("TTS Failed");

                const result = await response.json();
                const pcmBase64 = result.candidates[0].content.parts[0].inlineData.data;
                const binary = atob(pcmBase64);
                const array = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);

                // Convert PCM to WAV for browser playback
                const wavHeader = createWavHeader(array.length, 24000); // Puck uses 24kHz
                const blob = new Blob([wavHeader, array], { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(blob);
                const audio = new Audio(audioUrl);
                await audio.play();
            } catch (err) {
                console.error("GTS Voice Error:", err);
            }
        }

        function createWavHeader(dataLength, sampleRate) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            view.setUint32(0, 0x52494646, false); // RIFF
            view.setUint32(4, 36 + dataLength, true); // size
            view.setUint32(8, 0x57415645, false); // WAVE
            view.setUint32(12, 0x666d7420, false); // fmt 
            view.setUint32(16, 16, true); // subchunk 1 size
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); // byte rate
            view.setUint16(32, 2, true); // block align
            view.setUint16(34, 16, true); // bits per sample
            view.setUint32(36, 0x64617461, false); // data
            view.setUint32(40, dataLength, true);
            return buffer;
        }

        voiceToggle.addEventListener('click', () => {
            voiceEnabled = !voiceEnabled;
            voiceToggle.classList.toggle('text-blue-400', voiceEnabled);
            voiceToggle.classList.toggle('text-slate-600', !voiceEnabled);
            if (voiceEnabled) speak("Voice audit feedback active.");
        });

        // --- SCANNING LOGIC ---

        async function initCamera() {
            if (window.stream) window.stream.getTracks().forEach(track => track.stop());
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: useFrontCamera ? 'user' : 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                window.stream = stream;
                video.srcObject = stream;
                updateStatus("System Ready", "bg-emerald-500");
            } catch (err) { 
                showError("Camera Access Denied. Check GTS security settings.");
                updateStatus("Camera Error", "bg-red-500");
            }
        }

        function updateStatus(text, colorClass) {
            document.getElementById('status-text').innerText = text;
            document.getElementById('status-dot').className = `w-2 h-2 rounded-full ${colorClass}`;
        }

        function showError(msg) {
            document.getElementById('error-message').innerText = msg;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        async function analyzeImageWithRetry(base64, retries = 5) {
            const systemPrompt = `You are a Stock Auditor at GTS. Identify EVERY visible item. 
            Respond in JSON format: {"items": [{"name": "Specific Product Name", "count": 1}]}`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "What is visible on this shelf? Describe specific brands." }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    return JSON.parse(data.candidates[0].content.parts[0].text).items || [];
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        captureBtn.addEventListener('click', async () => {
            document.getElementById('shutter-effect').classList.add('flash-active');
            setTimeout(() => document.getElementById('shutter-effect').classList.remove('flash-active'), 300);
            
            document.getElementById('scanning-overlay').style.display = 'block';
            captureBtn.disabled = true;
            document.getElementById('btn-label').innerText = "AUDITING...";
            
            speak("Scanning inventory. Please hold steady.");

            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

                currentScanResults = await analyzeImageWithRetry(base64);
                
                if (currentScanResults.length > 0) {
                    renderSelection(currentScanResults);
                    selectionArea.classList.remove('hidden');
                    
                    // Verbal description of findings
                    const count = currentScanResults.length;
                    const itemsFound = currentScanResults.map(i => `${i.count || 1} ${i.name}`).join(", ");
                    speak(`Audit complete. I found ${count} different products, including ${itemsFound}. Review and confirm to update counts.`);
                    
                    updateStatus("Scan Complete", "bg-emerald-500");
                    selectionArea.scrollIntoView({ behavior: 'smooth' });
                } else {
                    speak("I am sorry, I couldn't identify any recognizable stock in this frame. Please try a different angle.");
                    updateStatus("No Items Found", "bg-yellow-500");
                }
            } catch (err) {
                speak("Connection interrupted. Retrying audit system.");
                showError("The audit system is currently busy.");
            } finally {
                document.getElementById('scanning-overlay').style.display = 'none';
                captureBtn.disabled = false;
                document.getElementById('btn-label').innerText = "SCAN VISIBLE ITEMS";
            }
        });

        function renderSelection(items) {
            detectionResults.innerHTML = items.map((item, i) => `
                <label class="flex items-center justify-between p-4 bg-white/5 border border-white/5 rounded-2xl cursor-pointer active:bg-blue-500/10 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <input type="checkbox" checked data-idx="${i}" class="peer hidden">
                            <div class="w-6 h-6 border-2 border-slate-700 rounded-lg peer-checked:bg-blue-600 peer-checked:border-blue-600 flex items-center justify-center transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4"><path d="M20 6L9 17l-5-5"/></svg>
                            </div>
                        </div>
                        <span class="text-sm font-bold text-slate-200">${item.name}</span>
                    </div>
                    <span class="text-blue-400 font-black text-xs">x${item.count || 1}</span>
                </label>
            `).join('');
        }

        document.getElementById('confirm-selection').addEventListener('click', () => {
            const checks = detectionResults.querySelectorAll('input[type="checkbox"]');
            let added = 0;
            checks.forEach(c => {
                if (c.checked) {
                    const item = currentScanResults[c.dataset.idx];
                    const qty = item.count || 1;
                    inventory[item.name] = (inventory[item.name] || 0) + qty;
                    added += qty;
                }
            });
            if (added > 0) {
                speak(`Confirmed. Added ${added} items to the inventory batch.`);
                renderInventory();
            }
            selectionArea.classList.add('hidden');
        });

        document.getElementById('cancel-selection').addEventListener('click', () => {
            speak("Discarding results. Standing by for next scan.");
            selectionArea.classList.add('hidden');
        });

        function renderInventory() {
            const keys = Object.keys(inventory);
            let total = 0;
            if (keys.length === 0) {
                inventoryList.innerHTML = `<div class="text-center py-12 glass rounded-3xl border-dashed border-white/10"><p class="text-slate-600 text-[10px] font-black uppercase tracking-widest">Empty Batch</p></div>`;
            } else {
                inventoryList.innerHTML = keys.map(k => {
                    total += inventory[k];
                    return `
                        <div class="flex items-center justify-between p-4 glass rounded-2xl border border-white/5 item-row">
                            <span class="text-sm font-black truncate pr-4 text-white uppercase tracking-tight">${k}</span>
                            <div class="flex items-center gap-1 bg-black/40 p-1 rounded-xl border border-white/5">
                                <button onclick="updateQty('${k.replace(/'/g, "\\'")}', -1)" class="w-10 h-10 flex items-center justify-center text-slate-500 font-bold hover:text-white">-</button>
                                <span class="w-8 text-center text-blue-400 font-black text-lg">${inventory[k]}</span>
                                <button onclic
