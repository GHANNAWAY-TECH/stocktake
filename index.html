<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Camera Stock Taking</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-slate-800">

<!-- HEADER -->
<header class="bg-indigo-600 text-white p-4 shadow">
  <h1 class="text-xl font-bold">ðŸ“¦ AI Camera Stock Taking System</h1>
  <p class="text-sm opacity-90">Scan â€¢ Analyze â€¢ Chat â€¢ Export</p>
</header>

<!-- MAIN GRID -->
<div class="grid md:grid-cols-2 gap-4 p-4">

  <!-- CAMERA SECTION -->
  <div class="bg-white rounded-xl shadow p-4">
    <h2 class="font-semibold mb-2">ðŸ“· Camera Scan</h2>

    <!-- Camera selection -->
    <select id="cameraSelect" class="border rounded w-full mb-2 p-1"></select>

    <video id="camera" autoplay class="rounded w-full border"></video>
    <button onclick="captureStock()" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
      Scan Stock
    </button>
    <canvas id="snapshot" class="hidden"></canvas>
  </div>

  <!-- CHAT SECTION -->
  <div class="bg-white rounded-xl shadow p-4 flex flex-col">
    <h2 class="font-semibold mb-2">ðŸ’¬ AI Stock Assistant</h2>
    <div id="chatBox" class="flex-1 overflow-y-auto border rounded p-2 text-sm space-y-2 bg-slate-50"></div>
    <div class="flex mt-2">
      <input id="chatInput" class="flex-1 border rounded-l px-2 py-1"
        placeholder="Ask AI anything about the stock..." />
      <button onclick="sendChat()" class="bg-indigo-600 text-white px-4 rounded-r">
        Send
      </button>
    </div>
  </div>
</div>

<!-- RESULTS -->
<div class="p-4 grid md:grid-cols-2 gap-4">

  <!-- STOCK LIST -->
  <div class="bg-white rounded-xl shadow p-4">
    <h2 class="font-semibold mb-2">ðŸ“Š Detected Stock</h2>
    <ul id="stockList" class="space-y-1 text-sm"></ul>
  </div>

  <!-- HISTORY -->
  <div class="bg-white rounded-xl shadow p-4">
    <h2 class="font-semibold mb-2">ðŸ—‚ Scan History</h2>
    <div id="history" class="text-sm space-y-2"></div>
    <button onclick="exportCSV()" class="mt-3 w-full bg-green-600 text-white py-2 rounded">
      Export CSV
    </button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_KEY = "AIzaSyDQzUp2le5ynm0GA-Py4Kkfgjl7Lnw-E-Q"; // Restricted to GitHub Pages URL
let lastScanText = "";
let currentStream = null;

/* ================= CAMERA ================= */
const camera = document.getElementById("camera");

// Populate camera dropdown
async function getCameras() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(d => d.kind === "videoinput");
  const cameraSelect = document.getElementById("cameraSelect");
  cameraSelect.innerHTML = "";
  videoDevices.forEach((d, i) => {
    const opt = document.createElement("option");
    opt.value = d.deviceId;
    opt.innerText = d.label || `Camera ${i+1}`;
    cameraSelect.appendChild(opt);
  });
  if(videoDevices.length>0) startCamera(videoDevices[0].deviceId);
}

// Start camera stream
async function startCamera(deviceId) {
  if(currentStream) currentStream.getTracks().forEach(track=>track.stop());
  currentStream = await navigator.mediaDevices.getUserMedia({ video: { deviceId } });
  camera.srcObject = currentStream;
}

// Switch camera
document.getElementById("cameraSelect").addEventListener("change", e => {
  startCamera(e.target.value);
});

getCameras().catch(()=>alert("No camera found"));

/* ================= SCAN STOCK ================= */
async function captureStock() {
  const canvas = document.getElementById("snapshot");
  canvas.width = camera.videoWidth;
  canvas.height = camera.videoHeight;
  canvas.getContext("2d").drawImage(camera,0,0);
  const imageBase64 = canvas.toDataURL("image/jpeg").split(",")[1];

  addChat("system","ðŸ“· Scanning stock...");

  const payload = {
    contents:[{
      parts:[
        { text: "List all visible products with quantities in JSON format." },
        { inlineData:{ mimeType:"image/jpeg", data:imageBase64 } }
      ]
    }]
  };

  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1/models/gemini-pro-vision:generateContent?key=${API_KEY}`,
      {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      }
    );
    const data = await res.json();
    lastScanText = JSON.stringify(data,null,2);
    renderStock(data);
    saveHistory(data);
    addChat("ai","âœ… Scan complete. You can ask me anything now.");
  } catch(err) {
    console.error(err);
    addChat("ai","âš ï¸ Error scanning stock.");
  }
}

/* ================= RENDER STOCK ================= */
function renderStock(data){
  const stockList = document.getElementById("stockList");
  stockList.innerHTML="";
  const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "No items detected";
  text.split("\n").forEach(line=>{
    if(line.trim()) stockList.innerHTML+=`<li>â€¢ ${line}</li>`;
  });
}

/* ================= CHAT ================= */
async function sendChat(){
  const input=document.getElementById("chatInput").value.trim();
  if(!input) return;
  addChat("user",input);
  document.getElementById("chatInput").value="";

  const payload={
    contents:[{
      parts:[{
        text:`You are a smart assistant. 
You have access to the scanned stock data:\n${lastScanText || "{}"}\n\nUser question: ${input}\nAnswer clearly and helpfully.`
      }]
    }]
  };

  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${API_KEY}`,
      {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      }
    );
    const data = await res.json();
    const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
    addChat("ai",reply);
  } catch(err) {
    console.error(err);
    addChat("ai","âš ï¸ Error contacting AI.");
  }
}

/* ================= CHAT UI ================= */
function addChat(role,text){
  const chatBox=document.getElementById("chatBox");
  const div=document.createElement("div");
  div.className = role==="user" ? "text-right text-indigo-700"
                  : role==="ai" ? "text-left text-green-700"
                  : "text-center text-gray-500 text-xs";
  div.innerText=text;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
}

/* ================= HISTORY ================= */
function saveHistory(data){
  const history=JSON.parse(localStorage.getItem("stockHistory")||"[]");
  history.unshift({ date:new Date().toLocaleString(), data });
  localStorage.setItem("stockHistory",JSON.stringify(history));
  renderHistory();
}

function renderHistory(){
  const history=JSON.parse(localStorage.getItem("stockHistory")||"[]");
  const historyDiv=document.getElementById("history");
  historyDiv.innerHTML="";
  history.slice(0,5).forEach(h=>{
    historyDiv.innerHTML+=`<div class="border-b pb-1">ðŸ“… ${h.date}</div>`;
  });
}
renderHistory();

/* ================= EXPORT CSV ================= */
function exportCSV(){
  let csv="Scan Date,Data\n";
  const history=JSON.parse(localStorage.getItem("stockHistory")||"[]");
  history.forEach(h=>{
    csv+=`"${h.date}","${JSON.stringify(h.data).replace(/"/g,'""')}"\n`;
  });
  const blob=new Blob([csv],{ type:"text/csv" });
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="ai_stock_history.csv";
  link.click();
}
</script>

</body>
</html>
